import { useEffect, useState } from "react";
import { useRouter } from "next/router";
import { Guides } from '@/components/Guides';
import { Resources } from '@/components/Resources';
import { HeroPattern } from '@/components/HeroPattern';

export const description = 'ORIGIN / Internal Resources.';

export default function Home() {
    const router = useRouter();
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        // ✅ Fetch user info securely from API instead of reading cookies directly
        const fetchUser = async () => {
            try {
                const res = await fetch("/api/auth/signin/userinfo");
                if (res.ok) {
                    const data = await res.json();
                    setUser(data.user);
                } else {
                    setUser(null);
                }
            } catch (error) {
                console.error("Failed to fetch user info:", error);
                setUser(null);
            } finally {
                setLoading(false);
            }
        };

        fetchUser();
    }, []);

    // ✅ Handle SAML Login - Redirects user to SAML authentication
    const handleLogin = () => {
        setLoading(true);
        window.location.href = `/api/auth/signin/saml`;
    };

    // ✅ Handle Logout - Clears session and reloads page
    const handleLogout = async () => {
        setLoading(true);
        await fetch("/api/auth/signout"); // Ensure session is cleared on backend
        document.cookie = "next-auth.session-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        router.reload();
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <p className="text-gray-600 text-xl">Checking authentication...</p>
            </div>
        );
    }

    if (!user) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <div className="bg-white text-gray-900 p-8 rounded-2xl shadow-xl w-96 text-center">
                    <h1 className="text-3xl font-bold mb-4">Welcome to ORIGIN</h1>
                    <p className="mb-6 text-gray-600">
                        Access internal resources securely with your Microsoft 365 account.
                    </p>
                    <button
                        onClick={handleLogin}
                        disabled={loading}
                        className={`w-full ${loading ? "bg-gray-400" : "bg-blue-600 hover:bg-blue-700"} 
                            text-white font-semibold py-2 px-4 rounded-xl transition duration-300`}
                    >
                        {loading ? "Signing In..." : "Sign In with Microsoft 365"}
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div>
            <HeroPattern />
            <h1 className="text-3xl font-bold text-center mt-6">Internal Resources</h1>
            <p className="text-center text-lg mt-2">Welcome, {user.name || "User"}!</p>
            <p className="text-center text-gray-600">{user.email || "No email available"}</p>

            <div className="max-w-4xl mx-auto mt-6 text-gray-800">
                <p className="mb-4">
                    Welcome to the Origin Resource Hub - designed to streamline access to essential resources, enabling each of you to navigate your roles with enhanced efficiency.
                </p>
                <p className="mb-4">
                    This hub is your go-to place for documents, training materials, and essential tools. It's designed to simplify your work life by putting everything you need right at your fingertips. Find what you're looking for and make the most of this handy resource. Your efficiency is our priority, and this hub is here to support your everyday tasks.
                </p>
                <p className="mb-4">
                    Please let your supervisor know if there is something that you feel should be added as a resource. Thank you for your hard work and dedication.
                </p>
            </div>

            <div className="mt-6 max-w-6xl mx-auto">
                <Guides />
                <Resources />
            </div>

            <div className="text-center mt-6">
                <button
                    onClick={handleLogout}
                    disabled={loading}
                    className={`px-6 py-2 text-white font-semibold rounded-xl transition duration-300 ${
                        loading ? "bg-gray-400" : "bg-red-500 hover:bg-red-600"
                    }`}
                >
                    {loading ? "Signing Out..." : "Sign Out"}
                </button>
            </div>
        </div>
    );
}
