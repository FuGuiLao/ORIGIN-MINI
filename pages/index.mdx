import { useEffect, useState } from "react";
import { useRouter } from "next/router";
import { useSession } from "next-auth/react";
import { Guides } from '@/components/Guides';
import { Resources } from '@/components/Resources';
import { HeroPattern } from '@/components/HeroPattern';

export const description = 'ORIGIN / Internal Resources.';

export default function Home() {
    const { data: session, status } = useSession();
    const router = useRouter();
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        // Capture SAML response from URL
        const urlParams = new URLSearchParams(window.location.search);
        const samlResponse = urlParams.get("samlResponse");

        if (samlResponse) {
            sessionStorage.setItem("samlToken", samlResponse);
            router.replace("/"); // ✅ Removes SAML response from URL
        }
    }, []);

    // Handle Login - Redirects user to NextAuth SAML sign-in page
    const handleLogin = () => {
        setLoading(true);
        window.location.href = `/api/auth/signin/saml`; // ✅ Forces GET request for NextAuth SAML
    };

    // Handle Logout
    const handleLogout = async () => {
        setLoading(true);
        window.location.href = `/api/auth/signout`; // ✅ Ensures logout request works
    };

    if (status === "loading") {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <p className="text-gray-600 text-xl">Checking authentication...</p>
            </div>
        );
    }

    if (!session) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <div className="bg-white text-gray-900 p-8 rounded-2xl shadow-xl w-96 text-center">
                    <h1 className="text-3xl font-bold mb-4">Welcome to ORIGIN</h1>
                    <p className="mb-6 text-gray-600">
                        Access internal resources securely with your Microsoft 365 account.
                    </p>
                    <button
                        onClick={handleLogin}
                        disabled={loading}
                        className={`w-full ${loading ? "bg-gray-400" : "bg-blue-600 hover:bg-blue-700"} 
                            text-white font-semibold py-2 px-4 rounded-xl transition duration-300`}
                    >
                        {loading ? "Signing In..." : "Sign In with Microsoft 365"}
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div>
            <HeroPattern />
            <h1>Internal Resources</h1>
            <p className="lead">Welcome, {session.user.name}!</p>
            <p className="lead">
                Welcome to the Origin Resource Hub - designed to streamline access to essential resources, enabling each of you to navigate your roles with enhanced efficiency.
            </p>
            <p className="lead">
                This hub is your go-to place for documents, training materials, and essential tools. It's designed to simplify your work life by putting everything you need right at your fingertips. Find what you're looking for and make the most of this handy resource. Your efficiency is our priority, and this hub is here to support your everyday tasks.
            </p>
            <p className="lead">
                Please let your supervisor know if there is something that you feel should be added as a resource. Thank you for your hard work and dedication.
            </p>

            <Guides />
            <Resources />

            <div className="mt-6">
                <button
                    onClick={handleLogout}
                    disabled={loading}
                    className={`w-full ${loading ? "bg-gray-400" : "bg-red-500 hover:bg-red-600"} 
                        text-white font-semibold py-2 px-4 rounded-xl transition duration-300`}
                >
                    {loading ? "Signing Out..." : "Sign Out"}
                </button>
            </div>
        </div>
    );
}
